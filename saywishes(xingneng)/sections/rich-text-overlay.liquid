{% comment %}
  区块名称：富文本文字覆盖背景（中文化）
  功能：
  - 可自定义背景图片（支持移动端单独设置），亮度可调
  - 中央区域富文本（中文）并支持段落对齐、行距、字重/斜体、颜色、高亮词汇
  - 响应式布局，WCAG对比度优化（叠加遮罩、白色文字默认）
  - 遵循Shopify最佳实践：作用域CSS/JS、懒加载、图片srcset、主题编辑器Schema中文说明
{% endcomment %}

<section id="section-{{ section.id }}" class="rt-overlay-section" aria-label="富文本覆盖背景">
  <div class="rt-overlay__media" style="--overlay-opacity: {{ settings.overlay_opacity }}; --brightness: {{ settings.image_brightness }};">
    {% if settings.bg_image %}
      {% assign bg = settings.bg_image %}
      <picture>
        {% if settings.bg_image_mobile %}
          {% assign bgm = settings.bg_image_mobile %}
          <source media="(max-width: 749px)" srcset="{{ bgm | image_url: width: 750 }} 750w, {{ bgm | image_url: width: 1100 }} 1100w, {{ bgm | image_url: width: 1500 }} 1500w" sizes="100vw">
        {% endif %}
        <img class="rt-overlay__img" loading="lazy" alt="{{ settings.bg_image_alt | escape }}" src="{{ bg | image_url: width: 1500 }}" width="{{ bg.width }}" height="{{ bg.height }}"
             srcset="{{ bg | image_url: width: 750 }} 750w, {{ bg | image_url: width: 1100 }} 1100w, {{ bg | image_url: width: 1500 }} 1500w, {{ bg | image_url: width: 2000 }} 2000w" sizes="100vw">
      </picture>
    {% endif %}
    <span class="rt-overlay__layer" aria-hidden="true"></span>
  </div>

  <div class="rt-overlay__content" style="color: {{ settings.text_color }}; text-align: {{ settings.text_align }};">
    <div class="rt-overlay__inner" style="max-width: {{ settings.content_max_width }}px;">
      {% for block in section.blocks %}
        {% case block.type %}
          {% when 'heading' %}
            <h2 class="rt-heading" style="font-size: {{ block.settings.font_size }}px; line-height: {{ block.settings.line_height }}; font-weight: {{ block.settings.font_weight }}; text-align: {{ block.settings.text_align }}; color: {{ block.settings.text_color | default: settings.text_color }};">{{ block.settings.text }}</h2>
          {% when 'paragraph' %}
            <div class="rt-paragraph" style="font-size: {{ block.settings.font_size }}px; line-height: {{ block.settings.line_height }}; font-style: {% if block.settings.italic %}italic{% else %}normal{% endif %}; font-weight: {{ block.settings.font_weight }}; text-align: {{ block.settings.text_align }}; color: {{ block.settings.text_color | default: settings.text_color }};" data-highlight-words="{{ block.settings.highlight_words }}">{{ block.settings.text }}</div>
          {% when 'button' %}
            <a class="rt-button" href="{{ block.settings.link }}" style="--btn-bg: {{ block.settings.bg_color }}; --btn-color: {{ block.settings.text_color }};">{{ block.settings.label }}</a>
        {% endcase %}
      {% endfor %}
    </div>
  </div>
</section>

<style>
  #shopify-section-{{ section.id }} { --section-padding-y: {{ settings.section_padding_y }}px; }
  #shopify-section-{{ section.id }} .rt-overlay-section { position: relative; display: grid; place-items: center; min-height: {{ settings.min_height }}vh; padding: var(--section-padding-y) 16px; }
  #shopify-section-{{ section.id }} .rt-overlay__media { position: absolute; inset: 0; overflow: hidden; }
  #shopify-section-{{ section.id }} .rt-overlay__img { width: 100%; height: 100%; object-fit: cover; filter: brightness(var(--brightness)); transform: translateZ(0); }
  #shopify-section-{{ section.id }} .rt-overlay__layer { position: absolute; inset: 0; background: rgba(0,0,0,var(--overlay-opacity)); }
  #shopify-section-{{ section.id }} .rt-overlay__content { position: relative; z-index: 1; width: 100%; display: grid; place-items: center; text-shadow: 0 1px 2px rgba(0,0,0,0.35); }
  #shopify-section-{{ section.id }} .rt-overlay__inner { width: 100%; }
  #shopify-section-{{ section.id }} .rt-heading { margin: 0 0 12px; }
  #shopify-section-{{ section.id }} .rt-paragraph { margin: 0 0 10px; }
  #shopify-section-{{ section.id }} .rt-button { display: inline-block; margin-top: 14px; padding: 12px 22px; background: var(--btn-bg, #111); color: var(--btn-color, #fff); border-radius: 6px; text-decoration: none; font-weight: 600; }
  #shopify-section-{{ section.id }} .rt-button:focus { outline: 2px solid #fff; outline-offset: 2px; }
  #shopify-section-{{ section.id }} mark { background: #ffeb3b; color: inherit; padding: 0 .1em; border-radius: 2px; }
  @media (min-width: 750px) {
    #shopify-section-{{ section.id }} .rt-overlay__inner { margin: 0 auto; }
  }
</style>

<script>
  (() => {
    const root = document.getElementById('shopify-section-{{ section.id }}');
    if (!root) return;
    // 高亮词汇：在每个段落内用 <mark> 包裹匹配词，支持用逗号分隔多个词
    root.querySelectorAll('.rt-paragraph').forEach(p => {
      const words = (p.getAttribute('data-highlight-words') || '').trim();
      if (!words) return;
      const list = words.split(',').map(w => w.trim()).filter(Boolean);
      if (!list.length) return;
      let html = p.innerHTML;
      list.forEach(word => {
        const safe = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(`(${safe})`, 'gi');
        html = html.replace(re, '<mark>$1</mark>');
      });
      p.innerHTML = html;
    });
  })();
</script>

{% schema %}
{
  "name": "图片背景",
  "tag": "section",
  "class": "section rt-overlay",
  "settings": [
    {"type": "image_picker", "id": "bg_image", "label": "背景图片（桌面）"},
    {"type": "image_picker", "id": "bg_image_mobile", "label": "背景图片（移动端可选）"},
    {"type": "text", "id": "bg_image_alt", "label": "背景图片替代文本（可访问性）", "default": "背景图片"},
    {"type": "range", "id": "image_brightness", "label": "图片亮度（0.3-1.3）", "min": 0.3, "max": 1.3, "step": 0.1, "default": 0.8},
    {"type": "range", "id": "overlay_opacity", "label": "叠加遮罩不透明度（提高对比度）", "min": 0, "max": 0.8, "step": 0.1, "default": 0.3},
    {"type": "color", "id": "text_color", "label": "文本颜色", "default": "#FFFFFF"},
    {"type": "range", "id": "content_max_width", "label": "内容最大宽度（px）", "min": 320, "max": 1400, "step": 20, "default": 900},
    {"type": "range", "id": "min_height", "label": "区块最小高度（视口百分比）", "min": 30, "max": 100, "step": 5, "default": 60},
    {"type": "select", "id": "text_align", "label": "整体对齐方式", "default": "center", "options": [
      {"value": "left", "label": "左对齐"},
      {"value": "center", "label": "居中"},
      {"value": "right", "label": "右对齐"}
    ]},
    {"type": "range", "id": "section_padding_y", "label": "上下内边距（px）", "min": 0, "max": 120, "step": 4, "default": 24}
  ],
  "blocks": [
    {
      "type": "heading",
      "name": "主标题",
      "settings": [
        {"type": "text", "id": "text", "label": "标题文本", "default": "获得一双鞋，种两棵树"},
        {"type": "range", "id": "font_size", "label": "字体大小（px）", "min": 18, "max": 72, "step": 2, "default": 30},
        {"type": "range", "id": "line_height", "label": "行距（倍数）", "min": 1, "max": 2, "step": 0.1, "default": 1.2},
        {"type": "select", "id": "font_weight", "label": "字重", "default": "700", "options": [
          {"value": "400", "label": "常规"},
          {"value": "500", "label": "中等"},
          {"value": "700", "label": "加粗"}
        ]},
        {"type": "select", "id": "text_align", "label": "对齐方式", "default": "center", "options": [
          {"value": "left", "label": "左对齐"},
          {"value": "center", "label": "居中"},
          {"value": "right", "label": "右对齐"}
        ]},
        {"type": "color", "id": "text_color", "label": "标题颜色（可选）"}
      ]
    },
    {
      "type": "paragraph",
      "name": "段落",
      "settings": [
        {"type": "richtext", "id": "text", "label": "段落内容", "default": "<p>在我们看来，呵护地球至关重要。每售出一双可持续球鞋，我们就在巴西雨林种下两棵树，以支持自然栖息地的修复与保护。</p>"},
        {"type": "range", "id": "font_size", "label": "字体大小（px）", "min": 12, "max": 32, "step": 1, "default": 16},
        {"type": "range", "id": "line_height", "label": "行距（倍数）", "min": 1, "max": 2, "step": 0.1, "default": 1.5},
        {"type": "select", "id": "font_weight", "label": "字重", "default": "400", "options": [
          {"value": "400", "label": "常规"},
          {"value": "500", "label": "中等"},
          {"value": "700", "label": "加粗"}
        ]},
        {"type": "checkbox", "id": "italic", "label": "斜体", "default": false},
        {"type": "select", "id": "text_align", "label": "对齐方式", "default": "center", "options": [
          {"value": "left", "label": "左对齐"},
          {"value": "center", "label": "居中"},
          {"value": "right", "label": "右对齐"}
        ]},
        {"type": "color", "id": "text_color", "label": "段落颜色（可选）"},
        {"type": "text", "id": "highlight_words", "label": "需要高亮的词（用逗号分隔）", "default": "两棵树, 可持续"}
      ]
    },
    {
      "type": "button",
      "name": "按钮",
      "settings": [
        {"type": "text", "id": "label", "label": "按钮文字", "default": "了解更多"},
        {"type": "url", "id": "link", "label": "链接地址"},
        {"type": "color", "id": "bg_color", "label": "按钮背景色", "default": "#2c2c2c"},
        {"type": "color", "id": "text_color", "label": "按钮文字颜色", "default": "#ffffff"}
      ]
    }
  ],
  "presets": [
    {"name": "图片背景", "category": "文本"}
  ]
}
{% endschema %}