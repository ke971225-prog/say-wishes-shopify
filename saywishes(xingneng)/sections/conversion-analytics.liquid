{% comment %}
  è½¬åŒ–ç‡åˆ†æå’ŒA/Bæµ‹è¯•ç»„ä»¶
  åŠŸèƒ½ï¼šè·Ÿè¸ªç”¨æˆ·è¡Œä¸ºã€è½¬åŒ–ç‡åˆ†æã€A/Bæµ‹è¯•ç­‰
{% endcomment %}

<style>
/* åˆ†æé¢æ¿æ ·å¼ */
.conversion-analytics-wrapper {
  font-family: system-ui, -apple-system, sans-serif;
}

.analytics-dashboard {
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin: 20px;
  padding: 15px;
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.dashboard-toggle {
  cursor: pointer;
  font-size: 20px;
}

.analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.analytics-card {
  background: #f8f9fa;
  border-radius: 6px;
  padding: 15px;
}

.card-title {
  color: #6c757d;
  font-size: 14px;
  margin-bottom: 8px;
}

.card-value {
  font-size: 24px;
  font-weight: bold;
  color: #212529;
}

.card-change {
  color: #28a745;
  font-size: 12px;
  margin-top: 5px;
}

.ab-test-section,
.heatmap-section {
  margin-top: 20px;
}

.ab-test-grid {
  display: grid;
  gap: 10px;
}

.ab-test-item {
  background: #f8f9fa;
  border-radius: 6px;
  padding: 12px;
  display: grid;
  grid-template-columns: 1fr auto auto;
  align-items: center;
  gap: 10px;
}

.test-status.active {
  color: #28a745;
}

.heatmap-placeholder {
  background: #f8f9fa;
  border-radius: 6px;
  padding: 20px;
  text-align: center;
  color: #6c757d;
}
</style>

<div class="conversion-analytics-wrapper" data-section-id="{{ section.id }}" style="display: none;">
  {% if section.settings.enable_analytics %}
    <!-- åˆ†ææ•°æ®æ˜¾ç¤ºé¢æ¿ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
    {% if request.design_mode %}
      <div class="analytics-dashboard">
        <div class="dashboard-header">
          <h3>è½¬åŒ–ç‡åˆ†æé¢æ¿</h3>
          <span class="dashboard-toggle" onclick="toggleDashboard()">ğŸ“Š</span>
        </div>
        
        <div class="dashboard-content" id="dashboard-content-{{ section.id }}">
          <div class="analytics-grid">
            <div class="analytics-card">
              <div class="card-title">é¡µé¢æµè§ˆé‡</div>
              <div class="card-value" id="page-views">0</div>
              <div class="card-change">+0% ä»Šæ—¥</div>
            </div>
            
            <div class="analytics-card">
              <div class="card-title">è½¬åŒ–ç‡</div>
              <div class="card-value" id="conversion-rate">0%</div>
              <div class="card-change">+0% ä»Šæ—¥</div>
            </div>
            
            <div class="analytics-card">
              <div class="card-title">å¼¹çª—è½¬åŒ–</div>
              <div class="card-value" id="popup-conversion">0%</div>
              <div class="card-change">+0% ä»Šæ—¥</div>
            </div>
            
            <div class="analytics-card">
              <div class="card-title">å¹³å‡åœç•™æ—¶é—´</div>
              <div class="card-value" id="avg-time">0s</div>
              <div class="card-change">+0% ä»Šæ—¥</div>
            </div>
          </div>
          
          <div class="ab-test-section">
            <h4>A/Bæµ‹è¯•çŠ¶æ€</h4>
            <div class="ab-test-grid">
              <div class="ab-test-item">
                <span class="test-name">è½¬ç›˜å¼¹çª—æµ‹è¯•</span>
                <span class="test-status active">è¿›è¡Œä¸­</span>
                <span class="test-result">A: 12.5% | B: 15.3%</span>
              </div>
              <div class="ab-test-item">
                <span class="test-name">é€€å‡ºæ„å›¾æµ‹è¯•</span>
                <span class="test-status active">è¿›è¡Œä¸­</span>
                <span class="test-result">A: 8.2% | B: 9.7%</span>
              </div>
            </div>
          </div>
          
          <div class="heatmap-section">
            <h4>ç”¨æˆ·è¡Œä¸ºçƒ­åŠ›å›¾</h4>
            <div class="heatmap-placeholder">
              <p>çƒ­åŠ›å›¾æ•°æ®åŠ è½½ä¸­...</p>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}
</div>

<!-- éšè—çš„è·Ÿè¸ªè„šæœ¬ -->
<script>
(function() {
  const sectionId = '{{ section.id }}';
  const settings = {
    enableAnalytics: {{ section.settings.enable_analytics | json }},
    enableAbTesting: {{ section.settings.enable_ab_testing | json }},
    enableHeatmap: {{ section.settings.enable_heatmap | json }},
    trackingId: '{{ section.settings.tracking_id | default: "CA-" }}{{ section.id }}',
    sampleRate: {{ section.settings.sample_rate | default: 100 }}
  };
  
  // æ£€æŸ¥æ˜¯å¦åº”è¯¥è·Ÿè¸ªæ­¤ç”¨æˆ·
  function shouldTrack() {
    return Math.random() * 100 < settings.sampleRate;
  }
  
  if (!settings.enableAnalytics || !shouldTrack()) {
    return;
  }
  
  // åˆå§‹åŒ–åˆ†ææ•°æ®
  let analyticsData = {
    sessionId: generateSessionId(),
    pageViews: 0,
    timeOnPage: 0,
    interactions: [],
    conversions: [],
    abTestGroup: null,
    startTime: Date.now()
  };
  
  // ç”Ÿæˆä¼šè¯ID
  function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }
  
  // A/Bæµ‹è¯•åˆ†ç»„
  function assignAbTestGroup() {
    if (!settings.enableAbTesting) return null;
    
    const groups = ['A', 'B'];
    const group = groups[Math.floor(Math.random() * groups.length)];
    
    // å­˜å‚¨åˆ°localStorageä»¥ä¿æŒä¸€è‡´æ€§
    const storageKey = `ab_test_group_${settings.trackingId}`;
    const existingGroup = localStorage.getItem(storageKey);
    
    if (existingGroup) {
      return existingGroup;
    }
    
    localStorage.setItem(storageKey, group);
    return group;
  }
  
  // è·Ÿè¸ªé¡µé¢æµè§ˆ
  function trackPageView() {
    analyticsData.pageViews++;
    sendAnalyticsEvent('page_view', {
      url: window.location.href,
      title: document.title,
      timestamp: Date.now()
    });
  }
  
  // è·Ÿè¸ªç”¨æˆ·äº¤äº’
  function trackInteraction(type, element, data = {}) {
    const interaction = {
      type: type,
      element: element,
      timestamp: Date.now(),
      data: data
    };
    
    analyticsData.interactions.push(interaction);
    sendAnalyticsEvent('interaction', interaction);
  }
  
  // è·Ÿè¸ªè½¬åŒ–äº‹ä»¶
  function trackConversion(type, value = 0, data = {}) {
    const conversion = {
      type: type,
      value: value,
      timestamp: Date.now(),
      data: data
    };
    
    analyticsData.conversions.push(conversion);
    sendAnalyticsEvent('conversion', conversion);
  }
  
  // å‘é€åˆ†æäº‹ä»¶
  function sendAnalyticsEvent(eventType, eventData) {
    const payload = {
      trackingId: settings.trackingId,
      sessionId: analyticsData.sessionId,
      eventType: eventType,
      eventData: eventData,
      abTestGroup: analyticsData.abTestGroup,
      userAgent: navigator.userAgent,
      timestamp: Date.now()
    };
    
    // å‘é€åˆ°åˆ†ææœåŠ¡å™¨ï¼ˆè¿™é‡Œä½¿ç”¨localStorageæ¨¡æ‹Ÿï¼‰
    const storageKey = `analytics_${settings.trackingId}_${Date.now()}`;
    localStorage.setItem(storageKey, JSON.stringify(payload));
    
    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥å‘é€åˆ°çœŸå®çš„åˆ†ææœåŠ¡å™¨
    // fetch('/analytics/track', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify(payload)
    // });
  }
  
  // çƒ­åŠ›å›¾è·Ÿè¸ª
  function initHeatmapTracking() {
    if (!settings.enableHeatmap) return;
    
    let mouseMovements = [];
    let clicks = [];
    
    // è·Ÿè¸ªé¼ æ ‡ç§»åŠ¨
    document.addEventListener('mousemove', function(e) {
      mouseMovements.push({
        x: e.clientX,
        y: e.clientY,
        timestamp: Date.now()
      });
      
      // é™åˆ¶æ•°æ®é‡
      if (mouseMovements.length > 1000) {
        mouseMovements = mouseMovements.slice(-500);
      }
    });
    
    // è·Ÿè¸ªç‚¹å‡»
    document.addEventListener('click', function(e) {
      // ç¡®ä¿ä¸å¹²æ‰°èœå•åŠŸèƒ½
      if (e.target.closest('.header__icon--menu, .mobile-menu-btn, #Details-menu-drawer-container')) {
        return; // ä¸å¤„ç†èœå•ç›¸å…³çš„ç‚¹å‡»
      }
      
      clicks.push({
        x: e.clientX,
        y: e.clientY,
        element: e.target.tagName,
        timestamp: Date.now()
      });
      
      trackInteraction('click', e.target.tagName, {
        x: e.clientX,
        y: e.clientY
      });
    });
    
    // å®šæœŸå‘é€çƒ­åŠ›å›¾æ•°æ®
    setInterval(function() {
      if (mouseMovements.length > 0 || clicks.length > 0) {
        sendAnalyticsEvent('heatmap', {
          mouseMovements: mouseMovements.slice(),
          clicks: clicks.slice()
        });
        
        mouseMovements = [];
        clicks = [];
      }
    }, 30000); // æ¯30ç§’å‘é€ä¸€æ¬¡
  }
  
  // è·Ÿè¸ªæ»šåŠ¨æ·±åº¦
  function trackScrollDepth() {
    let maxScroll = 0;
    let scrollMilestones = [25, 50, 75, 100];
    let trackedMilestones = [];
    
    window.addEventListener('scroll', function() {
      const scrollPercent = Math.round(
        (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100
      );
      
      maxScroll = Math.max(maxScroll, scrollPercent);
      
      scrollMilestones.forEach(milestone => {
        if (scrollPercent >= milestone && !trackedMilestones.includes(milestone)) {
          trackedMilestones.push(milestone);
          trackInteraction('scroll', 'page', { depth: milestone });
        }
      });
    });
  }
  
  // è·Ÿè¸ªé¡µé¢åœç•™æ—¶é—´
  function trackTimeOnPage() {
    setInterval(function() {
      analyticsData.timeOnPage = Date.now() - analyticsData.startTime;
    }, 1000);
    
    // é¡µé¢å¸è½½æ—¶å‘é€æœ€ç»ˆæ•°æ®
    window.addEventListener('beforeunload', function() {
      sendAnalyticsEvent('session_end', {
        timeOnPage: analyticsData.timeOnPage,
        interactions: analyticsData.interactions.length,
        conversions: analyticsData.conversions.length
      });
    });
  }
  
  // ç›‘å¬è½¬åŒ–äº‹ä»¶
  function setupConversionTracking() {
    // ç›‘å¬è¡¨å•æäº¤
    document.addEventListener('submit', function(e) {
      if (e.target.matches('form')) {
        trackConversion('form_submit', 1, {
          formId: e.target.id || 'unknown',
          formClass: e.target.className
        });
      }
    });
    
    // ç›‘å¬æ·»åŠ åˆ°è´­ç‰©è½¦
    document.addEventListener('click', function(e) {
      // ç¡®ä¿ä¸å¹²æ‰°èœå•åŠŸèƒ½
      if (e.target.closest('.header__icon--menu, .mobile-menu-btn, #Details-menu-drawer-container')) {
        return; // ä¸å¤„ç†èœå•ç›¸å…³çš„ç‚¹å‡»
      }
      
      if (e.target.matches('[data-add-to-cart], .btn-add-to-cart, .add-to-cart')) {
        trackConversion('add_to_cart', 1, {
          productId: e.target.dataset.productId || 'unknown'
        });
      }
    });
    
    // ç›‘å¬å¼¹çª—äº¤äº’
    document.addEventListener('click', function(e) {
      // ç¡®ä¿ä¸å¹²æ‰°èœå•åŠŸèƒ½
      if (e.target.closest('.header__icon--menu, .mobile-menu-btn, #Details-menu-drawer-container')) {
        return; // ä¸å¤„ç†èœå•ç›¸å…³çš„ç‚¹å‡»
      }
      
      if (e.target.closest('.spin-wheel-popup, .exit-intent-popup')) {
        trackInteraction('popup_interaction', e.target.tagName, {
          popupType: e.target.closest('[class*="popup"]').className
        });
      }
    });
  }
  
  // æ›´æ–°ä»ªè¡¨æ¿æ•°æ®ï¼ˆä»…åœ¨è®¾è®¡æ¨¡å¼ä¸‹ï¼‰
  function updateDashboard() {
    if (!document.querySelector('.analytics-dashboard')) return;
    
    // æ¨¡æ‹Ÿæ•°æ®æ›´æ–°
    const pageViewsEl = document.getElementById('page-views');
    const conversionRateEl = document.getElementById('conversion-rate');
    const popupConversionEl = document.getElementById('popup-conversion');
    const avgTimeEl = document.getElementById('avg-time');
    
    if (pageViewsEl) {
      pageViewsEl.textContent = analyticsData.pageViews;
    }
    
    if (conversionRateEl) {
      const conversionRate = analyticsData.conversions.length > 0 
        ? ((analyticsData.conversions.length / analyticsData.pageViews) * 100).toFixed(1)
        : '0.0';
      conversionRateEl.textContent = conversionRate + '%';
    }
    
    if (avgTimeEl) {
      const avgTime = Math.round(analyticsData.timeOnPage / 1000);
      avgTimeEl.textContent = avgTime + 's';
    }
  }
  
  // åˆå§‹åŒ–
  function init() {
    analyticsData.abTestGroup = assignAbTestGroup();
    
    trackPageView();
    initHeatmapTracking();
    trackScrollDepth();
    trackTimeOnPage();
    setupConversionTracking();
    
    // å®šæœŸæ›´æ–°ä»ªè¡¨æ¿
    setInterval(updateDashboard, 5000);
    
    // åˆå§‹æ›´æ–°
    updateDashboard();
  }
  
  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
  // æš´éœ²å…¨å±€è·Ÿè¸ªå‡½æ•°
  window.trackConversion = trackConversion;
  window.trackInteraction = trackInteraction;
})();

// ä»ªè¡¨æ¿åˆ‡æ¢å‡½æ•°
function toggleDashboard() {
  const content = document.querySelector('.dashboard-content');
  if (content) {
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
  }
}
</script>

{% schema %}
{
  "name": "è½¬åŒ–ç‡åˆ†æ",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "åˆ†æè®¾ç½®"
    },
    {
      "type": "checkbox",
      "id": "enable_analytics",
      "label": "å¯ç”¨è½¬åŒ–ç‡åˆ†æ",
      "default": true
    },
    {
      "type": "text",
      "id": "tracking_id",
      "label": "è·Ÿè¸ªID",
      "default": "CA-",
      "info": "ç”¨äºæ ‡è¯†æ­¤åˆ†æå®ä¾‹"
    },
    {
      "type": "range",
      "id": "sample_rate",
      "label": "é‡‡æ ·ç‡ (%)",
      "min": 1,
      "max": 100,
      "step": 1,
      "default": 100,
      "info": "è®¾ç½®è·Ÿè¸ªç”¨æˆ·çš„ç™¾åˆ†æ¯”"
    },
    {
      "type": "header",
      "content": "A/Bæµ‹è¯•è®¾ç½®"
    },
    {
      "type": "checkbox",
      "id": "enable_ab_testing",
      "label": "å¯ç”¨A/Bæµ‹è¯•",
      "default": true
    },
    {
      "type": "header",
      "content": "çƒ­åŠ›å›¾è®¾ç½®"
    },
    {
      "type": "checkbox",
      "id": "enable_heatmap",
      "label": "å¯ç”¨ç”¨æˆ·è¡Œä¸ºçƒ­åŠ›å›¾",
      "default": true
    },
    {
      "type": "header",
      "content": "æ•°æ®å­˜å‚¨è®¾ç½®"
    },
    {
      "type": "text",
      "id": "analytics_endpoint",
      "label": "åˆ†ææ•°æ®æ¥æ”¶ç«¯ç‚¹",
      "info": "ç•™ç©ºä½¿ç”¨æœ¬åœ°å­˜å‚¨"
    },
    {
      "type": "checkbox",
      "id": "gdpr_compliant",
      "label": "GDPRåˆè§„æ¨¡å¼",
      "default": true,
      "info": "å¯ç”¨åå°†è¯·æ±‚ç”¨æˆ·åŒæ„"
    }
  ],
  "presets": [
    {
      "name": "è½¬åŒ–ç‡åˆ†æ",
      "settings": {
        "enable_analytics": true,
        "enable_ab_testing": true,
        "enable_heatmap": true,
        "sample_rate": 100
      }
    }
  ]
}
{% endschema %}