{% comment %}
  Admin Order Processor for Custom Pricing
  This tool helps merchants quickly process orders with custom pricing
  Only visible in Shopify admin/preview mode
{% endcomment %}

{% if request.design_mode or request.preview_mode %}
<div id="admin-order-processor" style="
  position: fixed;
  top: 20px;
  right: 20px;
  width: 350px;
  background: white;
  border: 2px solid #007cba;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 10000;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  display: none;
">
  <div style="
    background: #007cba;
    color: white;
    padding: 15px;
    border-radius: 6px 6px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  ">
    <h3 style="margin: 0; font-size: 16px;">å®šåˆ¶ä»·æ ¼è®¢å•å¤„ç†å™¨</h3>
    <button onclick="toggleOrderProcessor()" style="
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
    ">Ã—</button>
  </div>
  
  <div style="padding: 20px;">
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600;">è®¢å•å·ï¼š</label>
      <input type="text" id="order-number" placeholder="#1001" style="
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      ">
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600;">å®¢æˆ·é‚®ç®±ï¼š</label>
      <input type="email" id="customer-email" placeholder="customer@example.com" style="
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      ">
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600;">å®é™…æ”¯ä»˜é‡‘é¢ï¼š</label>
      <input type="number" id="paid-amount" placeholder="40.00" step="0.01" style="
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      ">
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600;">å®šåˆ¶ä»·æ ¼æ€»è®¡ï¼š</label>
      <input type="number" id="custom-total" placeholder="65.00" step="0.01" style="
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      ">
    </div>
    
    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
        <span>ä»·æ ¼å·®å¼‚ï¼š</span>
        <span id="price-difference" style="font-weight: bold;">$0.00</span>
      </div>
      <div style="font-size: 12px; color: #666;" id="difference-note">è¯·è¾“å…¥é‡‘é¢è®¡ç®—å·®å¼‚</div>
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600;">å¤„ç†ç±»å‹ï¼š</label>
      <select id="process-type" style="
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      ">
        <option value="collect">éœ€è¦è¡¥æ”¶è´¹ç”¨</option>
        <option value="refund">éœ€è¦é€€æ¬¾</option>
        <option value="no-action">æ— éœ€å¤„ç†</option>
      </select>
    </div>
    
    <div style="display: flex; gap: 10px;">
      <button onclick="generateEmail()" style="
        flex: 1;
        background: #28a745;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      ">ç”Ÿæˆé‚®ä»¶</button>
      
      <button onclick="copyToClipboard()" style="
        flex: 1;
        background: #007cba;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      ">å¤åˆ¶é‚®ä»¶</button>
    </div>
    
    <div id="generated-email" style="
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      line-height: 1.4;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    "></div>
  </div>
</div>

<!-- è§¦å‘æŒ‰é’® -->
<button onclick="showOrderProcessor()" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #007cba;
  color: white;
  border: none;
  padding: 15px;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0,123,186,0.3);
  z-index: 9999;
  width: 60px;
  height: 60px;
  font-size: 24px;
" title="å®šåˆ¶ä»·æ ¼è®¢å•å¤„ç†å™¨">
  ğŸ’°
</button>

<script>
  function showOrderProcessor() {
    document.getElementById('admin-order-processor').style.display = 'block';
  }
  
  function toggleOrderProcessor() {
    const processor = document.getElementById('admin-order-processor');
    processor.style.display = processor.style.display === 'none' ? 'block' : 'none';
  }
  
  // å®æ—¶è®¡ç®—ä»·æ ¼å·®å¼‚
  document.addEventListener('DOMContentLoaded', function() {
    const paidInput = document.getElementById('paid-amount');
    const customInput = document.getElementById('custom-total');
    const differenceSpan = document.getElementById('price-difference');
    const noteDiv = document.getElementById('difference-note');
    const processSelect = document.getElementById('process-type');
    
    function calculateDifference() {
      const paid = parseFloat(paidInput.value) || 0;
      const custom = parseFloat(customInput.value) || 0;
      const difference = custom - paid;
      
      differenceSpan.textContent = '$' + Math.abs(difference).toFixed(2);
      
      if (difference > 0) {
        differenceSpan.style.color = '#d32f2f';
        noteDiv.textContent = 'éœ€è¦å‘å®¢æˆ·è¡¥æ”¶è´¹ç”¨';
        processSelect.value = 'collect';
      } else if (difference < 0) {
        differenceSpan.style.color = '#28a745';
        noteDiv.textContent = 'éœ€è¦å‘å®¢æˆ·é€€æ¬¾';
        processSelect.value = 'refund';
      } else {
        differenceSpan.style.color = '#666';
        noteDiv.textContent = 'ä»·æ ¼ä¸€è‡´ï¼Œæ— éœ€å¤„ç†';
        processSelect.value = 'no-action';
      }
    }
    
    paidInput.addEventListener('input', calculateDifference);
    customInput.addEventListener('input', calculateDifference);
  });
  
  function generateEmail() {
    const orderNumber = document.getElementById('order-number').value;
    const customerEmail = document.getElementById('customer-email').value;
    const paidAmount = parseFloat(document.getElementById('paid-amount').value) || 0;
    const customTotal = parseFloat(document.getElementById('custom-total').value) || 0;
    const processType = document.getElementById('process-type').value;
    const difference = Math.abs(customTotal - paidAmount);
    
    if (!orderNumber || !customerEmail) {
      alert('è¯·å¡«å†™è®¢å•å·å’Œå®¢æˆ·é‚®ç®±');
      return;
    }
    
    let emailContent = '';
    
    if (processType === 'collect') {
      emailContent = `
ä¸»é¢˜ï¼šè®¢å• ${orderNumber} - å®šåˆ¶æœåŠ¡è´¹ç”¨ç¡®è®¤

äº²çˆ±çš„å®¢æˆ·ï¼Œ

æ„Ÿè°¢æ‚¨çš„è®¢å•ï¼æˆ‘ä»¬æ³¨æ„åˆ°æ‚¨é€‰æ‹©äº†å®šåˆ¶æœåŠ¡é€‰é¡¹ã€‚

è®¢å•è¯¦æƒ…ï¼š
- è®¢å•å·ï¼š${orderNumber}
- å·²æ”¯ä»˜é‡‘é¢ï¼š$${paidAmount.toFixed(2)}
- å®šåˆ¶æœåŠ¡æ€»ä»·ï¼š$${customTotal.toFixed(2)}
- éœ€è¡¥æ”¶é‡‘é¢ï¼š$${difference.toFixed(2)}

è¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼å®Œæˆè¡¥æ¬¾ï¼š
1. PayPal: [æ‚¨çš„PayPalé‚®ç®±]
2. é“¶è¡Œè½¬è´¦: [é“¶è¡Œä¿¡æ¯]
3. æˆ–å›å¤æ­¤é‚®ä»¶é€‰æ‹©å…¶ä»–æ”¯ä»˜æ–¹å¼

æ”¶åˆ°è¡¥æ¬¾åï¼Œæˆ‘ä»¬å°†ç«‹å³å¼€å§‹åˆ¶ä½œæ‚¨çš„å®šåˆ¶è®¢å•ã€‚

å¦‚æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚

è°¢è°¢ï¼
{{ shop.name }}
      `;
    } else if (processType === 'refund') {
      emailContent = `
ä¸»é¢˜ï¼šè®¢å• ${orderNumber} - é€€æ¬¾é€šçŸ¥

äº²çˆ±çš„å®¢æˆ·ï¼Œ

æ„Ÿè°¢æ‚¨çš„è®¢å•ï¼

æˆ‘ä»¬å°†ä¸ºæ‚¨é€€è¿˜å¤šæ”¶çš„è´¹ç”¨ï¼š$${difference.toFixed(2)}
é€€æ¬¾å°†åœ¨1-3ä¸ªå·¥ä½œæ—¥å†…è¿”å›åˆ°æ‚¨çš„åŸæ”¯ä»˜æ–¹å¼ã€‚

è®¢å•å°†æŒ‰ç…§æ‚¨é€‰æ‹©çš„å®šåˆ¶è¦æ±‚è¿›è¡Œåˆ¶ä½œã€‚

è°¢è°¢ï¼
{{ shop.name }}
      `;
    } else {
      emailContent = `
ä¸»é¢˜ï¼šè®¢å• ${orderNumber} - è®¢å•ç¡®è®¤

äº²çˆ±çš„å®¢æˆ·ï¼Œ

æ„Ÿè°¢æ‚¨çš„è®¢å•ï¼ä»·æ ¼ç¡®è®¤æ— è¯¯ï¼Œæˆ‘ä»¬å°†ç«‹å³å¼€å§‹åˆ¶ä½œæ‚¨çš„å®šåˆ¶è®¢å•ã€‚

é¢„è®¡åˆ¶ä½œæ—¶é—´ï¼š3-5ä¸ªå·¥ä½œæ—¥

è°¢è°¢ï¼
{{ shop.name }}
      `;
    }
    
    document.getElementById('generated-email').innerHTML = emailContent.replace(/\n/g, '<br>');
    document.getElementById('generated-email').style.display = 'block';
  }
  
  function copyToClipboard() {
    const emailDiv = document.getElementById('generated-email');
    if (emailDiv.style.display === 'none') {
      alert('è¯·å…ˆç”Ÿæˆé‚®ä»¶å†…å®¹');
      return;
    }
    
    const emailText = emailDiv.innerText;
    navigator.clipboard.writeText(emailText).then(function() {
      alert('é‚®ä»¶å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }).catch(function() {
      // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
      const textArea = document.createElement('textarea');
      textArea.value = emailText;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert('é‚®ä»¶å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    });
  }
</script>
{% endif %}