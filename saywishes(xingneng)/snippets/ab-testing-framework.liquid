{% comment %}
  A/Bæµ‹è¯•æ¡†æ¶
  æ”¯æŒå¤šç§æµ‹è¯•åœºæ™¯å’Œè½¬åŒ–ä¼˜åŒ–
{% endcomment %}

{% if settings.ab_testing_enabled %}
<script>
  // A/Bæµ‹è¯•æ¡†æ¶åˆå§‹åŒ–
  window.ABTestFramework = {
    tests: {},
    userSegment: null,
    
    // åˆå§‹åŒ–ç”¨æˆ·åˆ†ç»„
    init: function() {
      this.userSegment = this.getUserSegment();
      this.loadActiveTests();
      this.trackTestExposure();
    },
    
    // è·å–ç”¨æˆ·åˆ†ç»„ï¼ˆåŸºäºcookieæˆ–localStorageï¼‰
    getUserSegment: function() {
      let segment = localStorage.getItem('ab_user_segment');
      if (!segment) {
        // åŸºäºç”¨æˆ·IDæˆ–éšæœºæ•°ç”Ÿæˆç¨³å®šçš„åˆ†ç»„
        const userId = '{{ customer.id | default: "anonymous" }}';
        const hash = this.hashCode(userId + document.location.hostname);
        segment = Math.abs(hash) % 100; // 0-99çš„åˆ†ç»„
        localStorage.setItem('ab_user_segment', segment);
      }
      return parseInt(segment);
    },
    
    // ç®€å•å“ˆå¸Œå‡½æ•°
    hashCode: function(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
      }
      return hash;
    },
    
    // åŠ è½½æ´»è·ƒçš„æµ‹è¯•é…ç½®
    loadActiveTests: function() {
      // äº§å“é¡µé¢æ ‡é¢˜æµ‹è¯•
      this.tests.productTitle = {
        name: 'Product Title Optimization',
        variants: {
          control: { weight: 50, title: 'original' },
          variant_a: { weight: 25, title: 'emotional' },
          variant_b: { weight: 25, title: 'benefit_focused' }
        }
      };
      
      // è´­ä¹°æŒ‰é’®æ–‡æ¡ˆæµ‹è¯•
      this.tests.buyButton = {
        name: 'Buy Button Text',
        variants: {
          control: { weight: 50, text: 'Add to Cart' },
          variant_a: { weight: 25, text: 'Order Your Video Now' },
          variant_b: { weight: 25, text: 'Create My Video' }
        }
      };
      
      // ä»·æ ¼å±•ç¤ºæµ‹è¯•
      this.tests.priceDisplay = {
        name: 'Price Display Format',
        variants: {
          control: { weight: 50, format: 'standard' },
          variant_a: { weight: 25, format: 'crossed_out' },
          variant_b: { weight: 25, format: 'value_emphasis' }
        }
      };
      
      // ç¤¾ä¼šè¯æ˜æµ‹è¯•
      this.tests.socialProof = {
        name: 'Social Proof Display',
        variants: {
          control: { weight: 50, show: false },
          variant_a: { weight: 25, show: true, type: 'reviews' },
          variant_b: { weight: 25, show: true, type: 'recent_orders' }
        }
      };
    },
    
    // è·å–æµ‹è¯•å˜ä½“
    getVariant: function(testName) {
      const test = this.tests[testName];
      if (!test) return null;
      
      let cumulativeWeight = 0;
      const randomValue = this.userSegment;
      
      for (const [variantName, config] of Object.entries(test.variants)) {
        cumulativeWeight += config.weight;
        if (randomValue < cumulativeWeight) {
          return {
            name: variantName,
            config: config,
            testName: testName
          };
        }
      }
      
      // é»˜è®¤è¿”å›æ§åˆ¶ç»„
      return {
        name: 'control',
        config: test.variants.control,
        testName: testName
      };
    },
    
    // åº”ç”¨æµ‹è¯•å˜ä½“
    applyVariant: function(testName, element) {
      const variant = this.getVariant(testName);
      if (!variant) return;
      
      switch (testName) {
        case 'productTitle':
          this.applyProductTitleVariant(variant, element);
          break;
        case 'buyButton':
          this.applyBuyButtonVariant(variant, element);
          break;
        case 'priceDisplay':
          this.applyPriceDisplayVariant(variant, element);
          break;
        case 'socialProof':
          this.applySocialProofVariant(variant, element);
          break;
      }
      
      // æ ‡è®°å…ƒç´ å·²åº”ç”¨æµ‹è¯•
      element.setAttribute('data-ab-test', testName);
      element.setAttribute('data-ab-variant', variant.name);
    },
    
    // äº§å“æ ‡é¢˜å˜ä½“åº”ç”¨
    applyProductTitleVariant: function(variant, element) {
      const originalTitle = element.textContent;
      
      switch (variant.config.title) {
        case 'emotional':
          element.textContent = 'Create Unforgettable Memories with ' + originalTitle;
          break;
        case 'benefit_focused':
          element.textContent = originalTitle + ' - Delivered in 24 Hours';
          break;
        // controlä¿æŒåŸæ ·
      }
    },
    
    // è´­ä¹°æŒ‰é’®å˜ä½“åº”ç”¨
    applyBuyButtonVariant: function(variant, element) {
      if (variant.config.text) {
        element.textContent = variant.config.text;
      }
    },
    
    // ä»·æ ¼å±•ç¤ºå˜ä½“åº”ç”¨
    applyPriceDisplayVariant: function(variant, element) {
      switch (variant.config.format) {
        case 'crossed_out':
          const originalPrice = element.textContent;
          const higherPrice = parseFloat(originalPrice.replace(/[^\d.]/g, '')) * 1.3;
          element.innerHTML = `<span style="text-decoration: line-through; color: #999;">${higherPrice.toFixed(2)}</span> ${originalPrice}`;
          break;
        case 'value_emphasis':
          element.style.fontSize = '1.2em';
          element.style.fontWeight = 'bold';
          element.style.color = '#e74c3c';
          break;
      }
    },
    
    // ç¤¾ä¼šè¯æ˜å˜ä½“åº”ç”¨
    applySocialProofVariant: function(variant, element) {
      if (variant.config.show) {
        element.style.display = 'block';
        
        if (variant.config.type === 'reviews') {
          element.innerHTML = 'â­â­â­â­â­ Over 1,000 happy customers!';
        } else if (variant.config.type === 'recent_orders') {
          element.innerHTML = 'ğŸ”¥ 3 people ordered this in the last hour';
        }
      } else {
        element.style.display = 'none';
      }
    },
    
    // è·Ÿè¸ªæµ‹è¯•æ›å…‰
    trackTestExposure: function() {
      // å‘é€æµ‹è¯•æ›å…‰äº‹ä»¶åˆ°åˆ†æå·¥å…·
      if (typeof gtag === 'function') {
        for (const testName of Object.keys(this.tests)) {
          const variant = this.getVariant(testName);
          gtag('event', 'ab_test_exposure', {
            test_name: testName,
            variant_name: variant.name,
            user_segment: this.userSegment
          });
        }
      }
    },
    
    // è·Ÿè¸ªè½¬åŒ–äº‹ä»¶
    trackConversion: function(conversionType, value = null) {
      const activeTests = document.querySelectorAll('[data-ab-test]');
      
      activeTests.forEach(element => {
        const testName = element.getAttribute('data-ab-test');
        const variantName = element.getAttribute('data-ab-variant');
        
        if (typeof gtag === 'function') {
          gtag('event', 'ab_test_conversion', {
            test_name: testName,
            variant_name: variantName,
            conversion_type: conversionType,
            conversion_value: value,
            user_segment: this.userSegment
          });
        }
      });
    }
  };
  
  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    window.ABTestFramework.init();
    
    // åº”ç”¨äº§å“é¡µé¢æµ‹è¯•
    {% if template contains 'product' %}
      const productTitle = document.querySelector('.product__title, h1');
      if (productTitle) {
        window.ABTestFramework.applyVariant('productTitle', productTitle);
      }
      
      const buyButtons = document.querySelectorAll('.btn--add-to-cart, [name="add"]');
      buyButtons.forEach(button => {
        window.ABTestFramework.applyVariant('buyButton', button);
      });
      
      const priceElements = document.querySelectorAll('.price, .product__price');
      priceElements.forEach(price => {
        window.ABTestFramework.applyVariant('priceDisplay', price);
      });
      
      const socialProofElements = document.querySelectorAll('.social-proof, .product-reviews-summary');
      socialProofElements.forEach(element => {
        window.ABTestFramework.applyVariant('socialProof', element);
      });
    {% endif %}
    
    // è·Ÿè¸ªè½¬åŒ–äº‹ä»¶
    document.addEventListener('submit', function(e) {
      if (e.target.matches('form[action*="cart"]')) {
        window.ABTestFramework.trackConversion('add_to_cart');
      }
    });
    
    // è·Ÿè¸ªè´­ä¹°å®Œæˆ
    {% if template contains 'customers/order' %}
      window.ABTestFramework.trackConversion('purchase', {{ order.total_price | money_without_currency | remove: ',' }});
    {% endif %}
  });
</script>
{% endif %}