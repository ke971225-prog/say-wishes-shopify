# 更新优化方案（PSI + 性能实践整合）

更新时间：2025-10-23
目标页：wishesvideo.com 首页（含 Hero）及核心模板（首页/产品/集合）

## PSI 关键数据摘要
- 移动端：FCP 1.8s；LCP 6.4s（需≤2.5s）；TBT 520ms；CLS 0.163（需≤0.1）；SI 5.7s
- 电脑端：FCP 0.4s；LCP 1.7s（达标）；TBT 1140ms（高）；CLS 0.445（高）
- 关键提示：Hero 背景图是 LCP；渲染屏蔽 CSS（accelerated-checkout-backwards-compat.css、seo-performance.css、component-list-payment.css）；字体（GTStandard woff2）链路长；第三方脚本负载重（hcaptcha、GTM、Facebook、Clarity、Judge.me）；网络负载总计 ~3.7MB；发现 10 项长任务；多处 ::before 导致 CLS。

## 核心目标（75 分位，移动端优先）
- LCP ≤ 2.5s；INP ≤ 200ms；CLS ≤ 0.1；TBT（实验室）≤ 300ms
- PSI（Mobile）≥ 70；PSI（Desktop）≥ 90

## 根因诊断要点（来自 PSI 报告）
- LCP：Hero 使用 CSS 变量背景图，未显式优先级（fetchpriority），资源不在 HTML 中“可发现”路径；首屏字体加载阻塞。
- 渲染屏蔽：小型 CSS 在关键路径（accelerated-checkout-backwards-compat.css、seo-performance.css、component-list-payment.css）。
- 字体：`cdn.shopify.com` GTStandard 两个 woff2 文件链路 2.3s+；可能未 `font-display: swap`。
- 第三方与主线程：hcaptcha（~584KB）、GTM、Facebook、Clarity、Judge.me 带来评估与解析开销，存在 10 个长任务；`wpm/*.js` 与 `performance-optimizer.js` 有强制重排热点。
- CLS：Hero Section 与 `promotional_banner` 的 `::before` 多次偏移，图片与 Banner 未预留尺寸；存在“图片元素没有明确 width/height”。
- 图片：若干图片过大/压缩不足（可节省 ~29KB），logo 显示尺寸远小于文件尺寸。

## 优化优先级与落地动作

### 1) Hero/LCP 关键资源（最高优先）
- 将 CSS 背景图改为 HTML 可发现的 `<picture>`/`<img>`，并设置优先级：
  ```html
  <link rel="preload" as="image" href="//wishesvideo.com/cdn/shop/files/20251001-135040.jpg?v=..." imagesrcset="...600w, ...1200w" imagesizes="(max-width:768px) 100vw, 1200px">
  <img src="//wishesvideo.com/cdn/shop/files/20251001-135040.jpg?v=..."
       srcset="...600w, ...1200w" sizes="(max-width:768px) 100vw, 1200px"
       width="1200" height="600" fetchpriority="high" decoding="async" alt="Hero">
  ```
- 避免对 LCP 图使用 `loading="lazy"`；保持在初始 HTML 中即可被发现。
- 位置：Homepage 对应的 Section（如 `sections/slideshow.liquid` 或自定义 Hero Section）。

### 2) 关键路径 CSS（高优先）
- 将首屏关键样式放入 `assets/critical.css`，`layout/theme.liquid` 内联；其余 CSS 异步加载：
  ```html
  <link rel="preload" as="style" href="{{ 'seo-performance.css' | asset_url }}">
  <link rel="stylesheet" href="{{ 'seo-performance.css' | asset_url }}" media="print" onload="this.media='all'">
  ```
- 首页不需要的样式（如 `accelerated-checkout-backwards-compat.css`、`component-list-payment.css`）仅在需要的模板加载。
- 清理/拆分未用 CSS（Judge.me base.css、`assets/base.min.css` 中未用部分）。

### 3) 字体策略（高优先）
- 为首屏正文/标题使用系统字体栈，或预加载少量必要字重；为自定义字体添加 `font-display: swap` 并限制字重/字形：
  ```css
  @font-face { font-family: 'GTStandard'; src: url('...woff2') format('woff2'); font-display: swap; }
  ```
- 若需预加载，谨慎添加 `<link rel="preload" as="font" crossorigin>`，仅限首屏必需字体。

### 4) 第三方与主线程（高优先）
- 将 hcaptcha 仅在需要的页面/组件（如含表单页）按需加载；首页移除或延后。
- GTM/FB/Clarity：统一经 Embed Blocks 控制注入范围；延后到 `DOMContentLoaded`+idle 或首交互后再加载：
  ```js
  requestIdleCallback(()=>loadGTM()); // 或在用户首交互后加载
  ```
- 拆分长任务：对初始化逻辑使用分片、`setTimeout(0)`/`requestIdleCallback`/`import()` 动态加载；减少同步读取布局。

### 5) CLS 修复（高优先）
- 为 Banner/图片预留固定尺寸（明确 `width`/`height` 或使用占位容器固定高度）。
- 移除/重构 `promotional_banner` 的 `::before` 动态插入与尺寸变更；避免在首屏阶段通过伪元素改变布局。
- 字体导致的文本跳动通过系统字体/`font-display: swap` 缓解。

### 6) 图片与媒体（中-高）
- 针对 PSI 提示的过大图片，重新导出并使用 `srcset/sizes` 响应式；logo 使用按需尺寸（50×50）并压缩。
- 对首屏外图片使用 `loading="lazy"`；对轮播/视频模块启用静态海报与延迟加载。

### 7) 资源提示与连接（中）
- 保留 `cdn.shopify.com` 的 `preconnect`；若 `geo.geoproapp.com` 为早期必需，可添加但总数≤4。
- 扩大自有资源的缓存 TTL；第三方不可控则减少首次注入次数与时机。

### 8) INP/TBT（中-高）
- 约束事件处理器复杂度与 DOM 更新频率；避免同步布局查询（如频繁 `offsetWidth`）。
- 虚拟化长列表（集合页）；拆分 `global.js` 初始化为更细粒度模块，按需加载。

## 页面类型执行计划
- 首页：Hero 改造、关键 CSS 异步化、系统字体/首屏字体精简、第三方延迟、首屏图片响应式。
- 集合页：图片懒加载、筛选交互（`facets.js`）去抖与批量更新、预留卡片尺寸、防抖滚动事件。
- 产品页：图集与 3D/视频延后加载、评论（Judge.me）在可视后/交互后注入、Shop Pay 脚本按需。

## 变更点位（主题文件）
- `layout/theme.liquid`：内联 `critical.css`，添加资源提示（preload/preconnect），异步加载非关键 CSS/JS。
- `sections/*.liquid`（Hero/Slideshow/Rich-Text）：将背景图改为 `<picture>/<img>` 并设置 `fetchpriority="high"` 与尺寸。
- `assets/global.js`：第三方加载时机统一管理、拆分长任务、按需动态导入。
- `snippets/gp-head.liquid`：集中维护预加载与预连接标签。

## 验证与目标
- 变更后进行 PSI（Mobile）连续 3 次采样并取中位；WebPageTest 单次稳定测试；Chrome DevTools 采样长任务。
- 目标：
  - Mobile：LCP ≤ 2.8s（第一阶段），CLS ≤ 0.08，TBT ≤ 300ms
  - Desktop：TBT ≤ 600ms，CLS ≤ 0.08
  - 迭代至 Mobile PSI ≥ 70，Desktop PSI ≥ 90

## 里程碑（建议）
- M1（今天）：Hero 改造 + 关键 CSS 异步化 + `font-display: swap`
- M2（本周）：第三方脚本分级加载 + 图片响应式与压缩
- M3（下周）：INP/TBT 交互优化 + CLS 全面回归测试并压线≤0.1

——
说明：本方案综合 `性能` 文件的重点（LCP/INP/CLS 优先级、Shopify 主题最佳实践）与 `性能优化.md` 的 PSI 数据与审计建议，后续我可按该方案对具体模板与资源进行精确改造。