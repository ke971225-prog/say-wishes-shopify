# 性能优化变更日志

日期：2025-10-22
主题：Shopify 主题性能优化（严格遵循 6A 原则与官方手册）
基线版本：请填入 Git commit hash（示例：`abc1234`）

## 变更概览
- 目标：提升首屏渲染速度、降低阻塞、优化 LCP/CLS/TBT/INP，不影响业务逻辑与视觉效果。
- 范围：`layout/theme.liquid`、`sections/hero-section.liquid`、`sections/main-collection-banner.liquid`、`sections/related-products.liquid`。
- 原则：不改变 UI 与业务行为，仅优化加载策略；全部通过 Liquid 模板验证。

## 详细变更

### 1) layout/theme.liquid（全站）
- 将非关键 CSS 由 `stylesheet_tag` 改为 `print + onload` 异步加载，避免渲染阻塞：
  - `base.min.css`
  - `seo-performance.css`
  - `component-list-payment.css`
  - `critical.css`（改为异步加载；首屏关键样式已内联保真）
  - 购物车 Drawer 场景下的相关 CSS（`component-cart-drawer.css`、`component-cart.css`、`component-totals.css`、`component-price.css`、`component-discounts.css`、`custom-cart-pricing.css`）
- 保留并优化：
  - 预测搜索 CSS 保持异步加载（原已使用 `media="print" onload`）。
  - 所有 JS 保持 `defer/async`，不改变执行顺序与业务逻辑。
  - 保留并利用已存在的 `preload_tag` 以进一步提前发现关键资源。

预期收益：
- 降低 CSS 阻塞，提升首帧与内容可见度；配合内联关键 CSS，降低 FOUC 风险。

### 2) sections/hero-section.liquid（首页）
- 为 CSS 背景的 LCP 英雄图添加 `<link rel="preload" as="image">`，并提供 `imagesrcset/imagesizes`，提升资源发现与带宽利用。
- 删除隐藏占位 `<img>`（避免重复请求与潜在 CLS 干扰），保留 CSS 背景绘制与所有视觉效果。
- 移动端与桌面端分别预加载对应分辨率，保证不同视口下的 LCP 稳定。

预期收益：
- 改善首屏 LCP 图像的发现与加载优先级，目标接近或优于 `LCP ≤ 2.5s`。

### 3) sections/main-collection-banner.liquid（集合页）
- 异步加载 `component-collection-hero.css`（`media="print" onload` + `noscript` 回退）。
- 在集合横幅图容器中插入 `<link rel="preload" as="image">`，并给出完整 `imagesrcset/imagesizes`，配合 `<img loading="eager" fetchpriority="high">`，确保首屏集合图像尽快被浏览器发现与调度。

预期收益：
- 集合页首屏图像更快推进下载队列，降低 LCP 并稳定图像尺寸计算。

### 4) sections/related-products.liquid（推荐产品块）
- 将以下样式改为异步加载（含 `noscript` 回退）：
  - `component-card.css`
  - `component-price.css`
  - `section-related-products.css`
- 在 `image_shape == 'blob'` 条件分支中将 `mask-blobs.css` 改为异步加载，避免该装饰性样式阻塞渲染。

预期收益：
- 推荐产品块样式不再阻塞主渲染，减少首次可交互前的阻塞时长（TBT）。

### 5) layout/theme.liquid（产品页）
- 在 `<head>` 中为产品首图（`product.featured_image`）添加 `<link rel="preload" as="image">`，提供 `imagesrcset/imagesizes`，加速浏览器提前发现并下载首屏产品图。

预期收益：
- 产品页 LCP 图像按视口优先快速加载，提升首屏稳定性与速度。

## 不影响范围声明
- 未更改所有页面结构与交互逻辑；UI 组件（支付图标、星级展示、A/B、埋点）行为保持不变。
- 未更改主题设置项（`section.settings` 与 `settings.*`）含义与默认值。

## 风险控制与验证
- 风险：CSS 异步加载可能导致轻微 FOUC；图像预加载需确保不触发重复请求。
- 缓解：已内联关键 CSS；其余 CSS 异步加载在 `onload` 后恢复 `media='all'`；预加载使用与实际 `srcset/sizes` 完全一致的 URL，避免重复下载。
- 验证：通过 Lighthouse、PSI、DevTools Performance 与 Coverage；观察 LCP、CLS、TBT、INP 指标与渲染顺序。

## 6A 原则映射
- Availability：减少阻塞与长任务，提升可用性与稳定性。
- Accessibility：保留语义与可访问标记，不更改 ARIA/结构；不影响读屏与键盘导航。
- Adaptability：响应式预加载与 `srcset`，适配多设备与网络状况。
- Agility：变更最小、可回滚、支持 A/B 实验。
- Automation：提供回滚脚本与审查清单，便于流程自动化。
- Analytics：保留并不阻塞原有 GA4 与监控脚本。

## 数据记录与下一步建议
- 在 `性能报告.md` 中追加集合页与产品页的前后指标对比；分别记录 LCP/CLS/INP/TBT 与 Lighthouse 分数。
- 对未压缩的小型 CSS/JS 进一步压缩（若无 `.min` 版本）。
- 使用 WebPageTest 与 PSI 进行对比测试并记录；考虑在 CI 中接入自动 Lighthouse 报告。